------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Fix Path Traversal Vulnerability in Image Delete - UI",
          "timestamp": 1767551272452,
          "response": {
            "content": "Implementation complete. Here's a summary of the changes made:\n\n## Summary: Fix Path Traversal Vulnerability in Image Delete\n\n### Changes Made\n\n**File:** `src/main/services/temp-image-service.js`\n\n1. **Added `isPathWithinTempDir()` method** (lines 71-90):\n   - Validates that a file path is safely within the temp image directory\n   - Uses `path.resolve()` to normalize paths and handle `..` traversal attempts\n   - Returns `false` for null/undefined paths or paths outside temp directory\n   - Adds `path.sep` suffix check to prevent partial directory matching\n\n2. **Updated `deleteImage()` method** (lines 135-154):\n   - Added path validation check at the start of the method\n   - Logs security warning for rejected path traversal attempts\n   - Returns `false` immediately for invalid paths without attempting deletion\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. deleteImage validates file path is within temp directory | âœ… \nImplemented via `isPathWithinTempDir()` |\n| 2. Attempts to delete files outside temp directory are logged and rejected | âœ… \nLogs `SECURITY: Rejected path traversal attempt` |\n| 3. Method returns false for invalid path attempts | âœ… \nReturns `false` before attempting deletion |\n\n### Security Protection\n\nThe implementation protects against:\n- `../../../etc/passwd` style path traversal\n- Absolute paths outside the temp directory\n- Null/undefined path inputs\n- Paths that match the temp directory prefix but point elsewhere (e.g., `/temp/img-malicious/`)",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 0.46916749999999996,
            "turns": 9,
            "duration": 77055,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\main\\services\\temp-image-service.js",
                "action": "write",
                "timestamp": 1767551324938
              }
            ],
            "timestamp": 1767551357015
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "67b5a2d5-2786-4714-8d4e-530705d50ef0",
          "branchType": "ui"
        },
        {
          "id": "mk02gtkol6fqan5hg",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Add Maximum File Size Validation for Image Upload**\n\nAs a developer, I want image uploads to enforce a maximum file size so that disk space cannot be exhausted by oversized files\n\n### Acceptance Criteria\n1. IPC handler validates image buffer size before processing\n2. Maximum file size limit of 50MB is enforced\n3. Uploads exceeding the limit return an error with a clear message\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Add Maximum File Size Validation for Image Upload - UI",
          "timestamp": 1767551400888,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Add Maximum File Size Validation for Image Upload\n\n### Changes Made\n\n**File:** `src/main/ipc-handlers.js`\n\n1. **Added `MAX_IMAGE_SIZE` constant** (line 27-28):\n   - Defined as `50 * 1024 * 1024` (50MB)\n   - Placed at module level for clear visibility\n\n2. **Added size validation in `image:save` handler** (lines 2302-2309):\n   - Checks buffer length against `MAX_IMAGE_SIZE` after conversion\n   - Returns descriptive error message showing actual file size in MB\n   - Prevents oversized files from being processed or saved\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. IPC handler validates image buffer size before processing | âœ… \nValidation added before `saveImage()` call |\n| 2. Maximum file size limit of 50MB is enforced | âœ… `MAX_IMAGE_SIZE = 50 * 1024 * 1024` |\n| 3. Uploads exceeding the limit return an error with a clear message | âœ… \nReturns `\"Image too large (X.XXMB). Maximum size is 50MB.\"` |\n\n### Error Message Example\n\nFor a 75MB image, the user would see:\n```\nImage too large (75.00MB). Maximum size is 50MB.\n```",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 0.5178177500000001,
            "turns": 13,
            "duration": 103014,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\main\\ipc-handlers.js",
                "action": "write",
                "timestamp": 1767551514501
              }
            ],
            "timestamp": 1767551543447
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "35211a0f-ec20-4e61-ad2a-990aacbb33b7",
          "branchType": "ui"
        },
        {
          "id": "mk02kdvdof9we5lvi",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Fix Paste Handler to Process All Images**\n\nAs a developer, I want pasting multiple images to attach all of them so that I don't lose images when pasting from clipboard\n\n### Acceptance Criteria\n1. Paste handler processes all image items from clipboard, not just the first\n2. Multiple pasted images are all added to the attachment list\n3. Processing handles mixed clipboard content correctly\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Fix Paste Handler to Process All Images - UI",
          "timestamp": 1767551567161,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Fix Paste Handler to Process All Images\n\n### Changes Made\n\n**File:** `src/renderer/components/prompt-editor/prompt-editor.js` (lines 370-393)\n\n**Before:**\n```javascript\nfor (const item of items) {\n  if (item.type.startsWith('image/')) {\n    e.preventDefault()\n    const file = item.getAsFile()\n    if (file) {\n      await this.processImageFile(file)\n    }\n    break // Only process first image  <-- BUG\n  }\n}\n```\n\n**After:**\n```javascript\n// Collect all image files from clipboard first\nconst imageFiles = []\nfor (const item of items) {\n  if (item.type.startsWith('image/')) {\n    const file = item.getAsFile()\n    if (file) {\n      imageFiles.push(file)\n    }\n  }\n}\n\n// Process all images if any found\nif (imageFiles.length > 0) {\n  e.preventDefault()\n  for (const file of imageFiles) {\n    await this.processImageFile(file)\n  }\n}\n```\n\n### Key Improvements\n\n1. **Removed `break` statement** - No longer stops after the first image\n2. **Collect-then-process pattern** - Gathers all image files before processing for cleaner logic\n3. **Single `preventDefault()`** - Only called once if images are found, not on every image\n4. **Handles mixed content correctly** - Text and other clipboard items are not affected when no images are present\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. Paste handler processes all image items from clipboard | âœ… \nLoop collects all images without breaking |\n| 2. Multiple pasted images are all added to the attachment list | âœ… \nEach file is processed via `processImageFile()` |\n| 3. Processing handles mixed clipboard content correctly | âœ… `preventDefault()` only called when images exist |",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 0.6333357499999999,
            "turns": 8,
            "duration": 58591,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\components\\prompt-editor\\prompt-editor.js",
                "action": "write",
                "timestamp": 1767551601271
              }
            ],
            "timestamp": 1767551638696
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "45bc87ca-99ba-4f09-8009-7263205debdd",
          "branchType": "ui"
        },
        {
          "id": "mk02mep0svdloi53f",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Limit Maximum Thumbnail Attachments to Five**\n\nAs a developer, I want a maximum of 5 image attachments so that the UI remains manageable and performance is maintained\n\n### Acceptance Criteria\n1. Maximum of 5 image attachments can be added to a prompt\n2. Attempts to add more than 5 images show a clear error or warning message\n3. UI prevents adding additional images once limit is reached\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Limit Maximum Thumbnail Attachments to Five - UI",
          "timestamp": 1767551661540,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Limit Maximum Thumbnail Attachments to Five\n\n### Changes Made\n\n**File:** `src/renderer/components/prompt-editor/prompt-editor.js`\n\n1. **Added `MAX_ATTACHMENTS` constant** (line 8):\n   ```javascript\n   const MAX_ATTACHMENTS = 5\n   ```\n\n2. **Added limit check in `processImageFile()`** (lines 472-481):\n   - Checks `this.attachedImages.length` against `MAX_ATTACHMENTS` before processing\n   - Shows warning toast using existing `window.puffinApp?.showToast?.()` pattern\n   - Returns early to prevent processing if limit reached\n\n### User Experience\n\nWhen a user tries to add a 6th image (via paste, drag-drop, or any other method), they will see:\n\n- **Toast type:** Warning (yellow/amber styling)\n- **Title:** \"Attachment Limit Reached\"  \n- **Message:** \"Maximum of 5 images allowed\"\n- **Duration:** 3 seconds\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. Maximum of 5 image attachments can be added to a prompt | âœ… \nCheck at start of `processImageFile()` |\n| 2. Attempts to add more than 5 images show a clear warning message | âœ… \nWarning toast with clear messaging |\n| 3. UI prevents adding additional images once limit is reached | âœ… \nEarly return prevents processing |\n\n### Edge Cases Handled\n\n- **Multi-paste scenario**: If user pastes 3 images when they already have 4, only the first one will be added (up to limit of 5), and the toast will appear for subsequent attempts\n- **Remove and re-add**: After removing an image, user can add more until limit is reached again",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 0.6182835,
            "turns": 11,
            "duration": 76818,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\components\\prompt-editor\\prompt-editor.js",
                "action": "write",
                "timestamp": 1767551731830
              }
            ],
            "timestamp": 1767551755737
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "50ad37d4-a4dd-4643-bc88-9209ec22b8ca",
          "branchType": "ui"
        },
        {
          "id": "mk02quo7dkdyagezi",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Fix Pre-generation Race Condition in Sprint Close**\n\nAs a developer, I want the commit message pre-generation to properly await completion so that the modal always displays the generated message\n\n### Acceptance Criteria\n1. Pre-generation completes before modal renders or modal shows loading state\n2. No duplicate synchronous fallback generation occurs\n3. Async wrapper correctly handles the generation promise\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Fix Pre-generation Race Condition in Sprint Close - UI",
          "timestamp": 1767551868871,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Fix Pre-generation Race Condition in Sprint Close\n\n### Changes Made\n\n**File:** `src/renderer/lib/modal-manager.js`\n\n1. **Added `_commitMessageUpdateCallback` state variable** (line 25):\n   - Stores a callback function that updates the commit message area when pre-generation completes\n\n2. **Updated `preGenerateSprintCommitMessage()`** (lines 116-136):\n   - Added `await new Promise(resolve => setTimeout(resolve, 0))` to yield execution\n   - This allows the modal to render with loading state before generation completes\n   - Added callback trigger in `finally` block to update UI when generation completes\n\n3. **Added callback registration in `renderSprintClose()`** (lines 519-551):\n   - Callback updates the commit message textarea when pre-generation finishes\n   - Handles both cases: textarea exists (update value) or loading spinner shown (replace with textarea)\n   - Re-attaches input listener when replacing loading spinner\n\n4. **Cleanup callback on cancel/confirm** (lines 592, 630):\n   - Clears `_commitMessageUpdateCallback` when modal is cancelled or confirmed\n\n### How It Works\n\n1. User clicks \"Close Sprint\" button\n2. `preCheckGitStatus()` and `preGenerateSprintCommitMessage()` are called\n3. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true`\n4. Modal opens immediately and renders with \"Generating commit message...\" spinner\n5. The `setTimeout(0)` yields control, allowing modal to render\n6. Commit message is generated synchronously\n7. `_commitMessageGenerating = false` and callback is triggered\n8. Callback replaces spinner with textarea containing generated message\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. Pre-generation completes before modal renders OR modal shows loading state | âœ… \nModal shows loading spinner, then updates when ready |\n| 2. No duplicate synchronous fallback generation occurs | âœ… \nMessage is pre-generated; fallback is avoided |\n| 3. Async wrapper correctly handles the generation promise | âœ… \nUses `setTimeout(0)` to properly yield and callback to update UI |",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 2.2870877499999995,
            "turns": 33,
            "duration": 274367,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\lib\\modal-manager.js",
                "action": "write",
                "timestamp": 1767552106919
              }
            ],
            "timestamp": 1767552149854
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "24d893d3-c14d-4134-96ad-7174ec6bb8e0",
          "branchType": "ui"
        },
        {
          "id": "mk030vcazm0p0yfag",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Add Debouncing to Project Form Input Handler**\n\nAs a developer, I want input changes in the project form to be debounced so that rapid typing doesn't cause excessive updates\n\n### Acceptance Criteria\n1. handleInputChange function is debounced with appropriate delay\n2. Rapid keystrokes result in single update after typing stops\n3. Form remains responsive during debounce period\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Add Debouncing to Project Form Input Handler - UI",
          "timestamp": 1767552336298,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Add Debouncing to Project Form Input Handler\n\n### Changes Made\n\n**File:** `src/renderer/components/project-form/project-form.js`\n\n1. **Added `INPUT_DEBOUNCE_DELAY` constant** (line 15):\n   ```javascript\n   const INPUT_DEBOUNCE_DELAY = 500\n   ```\n\n2. **Added `debounce` utility function** (lines 17-29):\n   - Standard debounce implementation\n   - Clears pending timeout on each call\n   - Executes function after delay expires\n   - Preserves `this` context\n\n3. **Added debounced handler in constructor** (lines 41-45):\n   ```javascript\n   this._debouncedUpdateConfig = debounce(() => {\n     const formData = this.getFormData()\n     this.intents.updateConfig(formData)\n   }, INPUT_DEBOUNCE_DELAY)\n   ```\n\n4. **Updated `handleInputChange()` method** (lines 307-310):\n   - Now delegates to the debounced handler\n   - Added JSDoc comment explaining debouncing behavior\n\n### How It Works\n\n1. User types rapidly in any form field\n2. Each keystroke calls `handleInputChange()`\n3. `handleInputChange()` calls `_debouncedUpdateConfig()`\n4. Debounce clears any pending timeout and sets a new 500ms timer\n5. After 500ms of no typing, `getFormData()` and `updateConfig()` are called once\n6. Form remains fully responsive during the debounce period (no blocking)\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. handleInputChange function is debounced with appropriate delay | âœ… 500ms debounce delay |\n| 2. Rapid keystrokes result in single update after typing stops | âœ… \nOnly final state is saved after 500ms pause |\n| 3. Form remains responsive during debounce period | âœ… \nNo blocking - debounce is non-blocking |",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 1.57689525,
            "turns": 15,
            "duration": 128506,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\components\\project-form\\project-form.js",
                "action": "write",
                "timestamp": 1767552434557
              }
            ],
            "timestamp": 1767552472211
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "478e5c48-522a-434c-8393-7c0f367055e4",
          "branchType": "ui"
        },
        {
          "id": "mk03bnz5w06dgvtw1",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Add Null Checks to Project Form getFormData**\n\nAs a developer, I want getFormData to safely handle null values so that the application doesn't crash on missing form elements\n\n### Acceptance Criteria\n1. getFormData includes null checks for all form element accesses\n2. Missing elements are handled gracefully with default values\n3. No crashes occur when form elements are unexpectedly missing\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Add Null Checks to Project Form getFormData - UI",
          "timestamp": 1767552839969,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Add Null Checks to Project Form getFormData\n\n### Changes Made\n\n**File:** `src/renderer/components/project-form/project-form.js`\n\n1. **Added `getElementValue()` helper method** (lines 265-278):\n   - Safely retrieves form element values with null checking\n   - Logs warning if element is missing\n   - Returns default value when element is null\n   - Handles both trimmed and non-trimmed values via optional chaining\n\n2. **Added `getCheckboxValue()` helper method** (lines 280-289):\n   - Safely retrieves checkbox checked state\n   - Returns default boolean if element is missing\n\n3. **Updated `getFormData()` method** (lines 291-329):\n   - All 20+ form element accesses now use safe accessors\n   - Sensible default values provided for all fields:\n     - `defaultModel: 'optus'`\n     - `programmingStyle: 'hybrid'`\n     - `testingApproach: 'bdd'`\n     - Color palette defaults (Bootstrap-like colors)\n     - etc.\n\n### Key Features\n\n- **No crashes**: Missing elements return defaults instead of throwing\n- **Logging**: Missing elements log warnings for debugging\n- **Backwards compatible**: Existing code using `getFormData()` works unchanged\n- **Sensible defaults**: Values match typical project configuration defaults\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. getFormData includes null checks for all form element accesses | âœ… \nAll 20+ accesses use safe helpers |\n| 2. Missing elements are handled gracefully with default values | âœ… \nSensible defaults for all fields |\n| 3. No crashes occur when form elements are unexpectedly missing | âœ… \nNull checks prevent TypeError crashes |",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 1.3141820000000002,
            "turns": 9,
            "duration": 90919,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\components\\project-form\\project-form.js",
                "action": "write",
                "timestamp": 1767552903416
              }
            ],
            "timestamp": 1767552939333
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "49a34f12-9d92-430c-a2e3-d4c4a1198b56",
          "branchType": "ui"
        },
        {
          "id": "mk03e37xrve927nx8",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Validate Plugin Icons Before DOM Insertion**\n\nAs a developer, I want plugin icons to be validated before insertion so that malicious or malformed content cannot be injected into the DOM\n\n### Acceptance Criteria\n1. Plugin icons are validated for safe content before DOM insertion\n2. Invalid or potentially malicious icons are rejected\n3. Safe fallback icon is used when validation fails\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\nNow I have all the information needed to create a comprehensive implementation plan. Let me write it:\n\n---\n\n# Sprint Implementation Plan: Code Quality & Security Fixes\n\n## Executive Summary\n\nThis sprint addresses 8 user stories focused on security hardening, input validation, UX improvements, and code robustness. The stories are primarily independent, with some shared patterns that can be leveraged for consistency.\n\n---\n\n## Architecture Analysis\n\n### Shared Patterns & Dependencies\n\n| Pattern | Stories Affected | Notes |\n|---------|-----------------|-------|\n| Path validation | Story 1, Story 2 | Both involve file system security in temp-image-service |\n| Toast notifications | Story 4, Story 2 | Both need user-facing error/warning messages |\n| Input sanitization | Story 7, Story 8 | Both handle potentially missing/malformed input |\n| Async handling | Story 3, Story 5 | Both fix incomplete async patterns |\n\n### Key Files by Story\n\n| Story | Primary File(s) | Secondary Files |\n|-------|-----------------|-----------------|\n| 1 | `src/main/services/temp-image-service.js` | - |\n| 2 | `src/main/ipc-handlers.js` | - |\n| 3 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 4 | `src/renderer/components/prompt-editor/prompt-editor.js` | - |\n| 5 | `src/renderer/app.js`, `src/renderer/lib/modal-manager.js` | - |\n| 6 | `src/renderer/components/project-form/project-form.js` | - |\n| 7 | `src/renderer/components/project-form/project-form.js` | - |\n| 8 | `src/renderer/components/project-form/project-form.js` | - |\n\n---\n\n## Implementation Order (Recommended)\n\n### Phase 1: Security Fixes (Critical)\n1. **Story 1: Path Traversal Vulnerability** - Security critical\n2. **Story 2: Max File Size Validation** - Security critical  \n3. **Story 8: Plugin Icon Validation** - XSS prevention\n\n### Phase 2: Bug Fixes\n4. **Story 3: Paste Handler Multi-Image** - Functionality fix\n5. **Story 5: Pre-generation Race Condition** - UX bug fix\n\n### Phase 3: Enhancements\n6. **Story 4: Max Attachments Limit** - UX enhancement\n7. **Story 6: Debouncing Input Handler** - Performance\n8. **Story 7: Null Checks in getFormData** - Robustness\n\n---\n\n## Detailed Technical Approach\n\n### Story 1: Fix Path Traversal Vulnerability in Image Delete\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/services/temp-image-service.js:114-127\nasync deleteImage(filePath) {\n  try {\n    await fs.unlink(filePath)  // No path validation!\n    // ...\n  }\n}\n```\n\n**Technical Approach:**\n1. Add a `isPathWithinTempDir(filePath)` helper method that:\n   - Resolves both `filePath` and `this.tempImgPath` to absolute paths using `path.resolve()`\n   - Uses `path.normalize()` to handle `..` traversal attempts\n   - Checks that resolved path starts with the temp directory path\n2. Call this validation at the start of `deleteImage()` \n3. Log security warning and return `false` for invalid paths\n\n**Implementation:**\n```javascript\nisPathWithinTempDir(filePath) {\n  if (!this.tempImgPath || !filePath) return false\n  const resolvedPath = path.resolve(filePath)\n  const resolvedTempDir = path.resolve(this.tempImgPath)\n  return resolvedPath.startsWith(resolvedTempDir + path.sep) || \n         resolvedPath === resolvedTempDir\n}\n\nasync deleteImage(filePath) {\n  if (!this.isPathWithinTempDir(filePath)) {\n    console.warn(`[TempImageService] SECURITY: Rejected path traversal attempt: ${filePath}`)\n    return false\n  }\n  // ... existing logic\n}\n```\n\n**Files Changed:**\n- `src/main/services/temp-image-service.js`\n\n---\n\n### Story 2: Add Maximum File Size Validation for Image Upload\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/main/ipc-handlers.js:2285-2311\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // No size validation!\n  const imageBuffer = Buffer.from(buffer)\n  const result = await tempImageService.saveImage(imageBuffer, extension, originalName)\n})\n```\n\n**Technical Approach:**\n1. Define `MAX_IMAGE_SIZE = 50 * 1024 * 1024` (50MB) constant in ipc-handlers.js\n2. Add size check immediately after converting buffer\n3. Return clear error message with size info\n\n**Implementation:**\n```javascript\nconst MAX_IMAGE_SIZE = 50 * 1024 * 1024 // 50MB\n\nipcMain.handle('image:save', async (event, { buffer, extension, originalName }) => {\n  // ... initialization checks ...\n  \n  const imageBuffer = Buffer.from(buffer)\n  \n  // Validate file size\n  if (imageBuffer.length > MAX_IMAGE_SIZE) {\n    const sizeMB = (imageBuffer.length / (1024 * 1024)).toFixed(2)\n    return { \n      success: false, \n      error: `Image too large (${sizeMB}MB). Maximum size is 50MB.` \n    }\n  }\n  \n  // ... existing logic\n})\n```\n\n**Files Changed:**\n- `src/main/ipc-handlers.js`\n\n---\n\n### Story 3: Fix Paste Handler to Process All Images\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/prompt-editor/prompt-editor.js:371-385\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      e.preventDefault()\n      const file = item.getAsFile()\n      if (file) {\n        await this.processImageFile(file)\n      }\n      break // Only process first image <-- BUG!\n    }\n  }\n})\n```\n\n**Technical Approach:**\n1. Remove the `break` statement that stops after first image\n2. Collect all image files first, then process them\n3. Only call `e.preventDefault()` once if any images found\n4. Consider max attachment limit (ties into Story 4)\n\n**Implementation:**\n```javascript\nthis.textarea.addEventListener('paste', async (e) => {\n  const items = e.clipboardData?.items\n  if (!items) return\n\n  // Collect all image files from clipboard\n  const imageFiles = []\n  for (const item of items) {\n    if (item.type.startsWith('image/')) {\n      const file = item.getAsFile()\n      if (file) {\n        imageFiles.push(file)\n      }\n    }\n  }\n\n  // Process all images if any found\n  if (imageFiles.length > 0) {\n    e.preventDefault()\n    for (const file of imageFiles) {\n      await this.processImageFile(file)\n    }\n  }\n})\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 4: Limit Maximum Thumbnail Attachments to Five\n\n**Complexity:** Low\n\n**Current State:**\n- No limit on `this.attachedImages` array\n- Images added freely via paste, drag-drop, or file selection\n\n**Technical Approach:**\n1. Define `MAX_ATTACHMENTS = 5` constant in PromptEditorComponent\n2. Add check in `processImageFile()` before processing\n3. Show warning toast using existing `window.puffinApp?.showToast?.()`\n4. Prevent processing if limit reached\n\n**Implementation:**\n```javascript\n// Add constant at class level\nconst MAX_ATTACHMENTS = 5\n\nasync processImageFile(file) {\n  // Check attachment limit\n  if (this.attachedImages.length >= MAX_ATTACHMENTS) {\n    window.puffinApp?.showToast?.({\n      type: 'warning',\n      title: 'Attachment Limit Reached',\n      message: `Maximum of ${MAX_ATTACHMENTS} images allowed`,\n      duration: 3000\n    })\n    return\n  }\n  \n  // ... existing processing logic\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/prompt-editor/prompt-editor.js`\n\n---\n\n### Story 5: Fix Pre-generation Race Condition in Sprint Close\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/app.js:1985-1993\ncloseBtn.addEventListener('click', () => {\n  // Pre-fetch git status and commit message asynchronously (non-blocking)\n  if (this.modalManager) {\n    this.modalManager.preCheckGitStatus()\n    this.modalManager.preGenerateSprintCommitMessage(sprint, userStories)  // Not awaited!\n  }\n  \n  // Show modal immediately - data will be ready or loading\n  this.intents.showModal('sprint-close', { sprint })  // Race condition!\n})\n```\n\nThe issue: `preGenerateSprintCommitMessage` is async but not awaited. The modal opens immediately and may render before generation completes.\n\n**Current Modal Rendering:**\n```javascript\n// src/renderer/lib/modal-manager.js:366-379\nconst isGenerating = this._commitMessageGenerating\n\nif (this._hasUserEditedMessage && this._userEditedCommitMessage !== null) {\n  commitMessage = this._userEditedCommitMessage\n} else if (this._pendingCommitMessage) {\n  commitMessage = this._pendingCommitMessage\n} else if (!isGenerating) {\n  // Generate synchronously if not pre-generated  <-- Fallback that shouldn't be needed\n  commitMessage = this.generateSprintCommitMessage(sprint, userStories)\n}\n```\n\n**Technical Approach:**\nThe modal already has a loading state (`isGenerating` check), but the issue is:\n1. `preGenerateSprintCommitMessage` sets `_commitMessageGenerating = true` then immediately sets it to `false` in `finally` because `generateSprintCommitMessage` is synchronous\n2. By the time modal renders, generation is already complete OR hasn't started yet\n\n**Fix Options:**\n1. **Option A (Recommended):** Make the modal re-render when generation completes by using a callback\n2. **Option B:** Await the pre-generation before showing modal (adds delay)\n\n**Implementation (Option A - Modal Re-render):**\n```javascript\n// src/renderer/lib/modal-manager.js\nasync preGenerateSprintCommitMessage(sprint, userStories = []) {\n  if (!sprint) return ''\n\n  this._commitMessageGenerating = true\n  this._pendingCommitMessage = null\n  \n  // Trigger modal re-render if visible\n  this._triggerModalUpdate?.()\n\n  try {\n    // Simulate async for proper loading state (if generation becomes async in future)\n    await Promise.resolve()\n    \n    const message = this.generateSprintCommitMessage(sprint, userStories)\n    this._pendingCommitMessage = message\n    return message\n  } finally {\n    this._commitMessageGenerating = false\n    // Trigger modal re-render to show generated message\n    this._triggerModalUpdate?.()\n  }\n}\n```\n\nAdd in `renderModal()`:\n```javascript\n// Store re-render callback for async updates\nthis._triggerModalUpdate = () => {\n  if (this._currentModalRender) {\n    this._currentModalRender()\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/lib/modal-manager.js`\n- `src/renderer/app.js` (minor: ensure callback is properly connected)\n\n---\n\n### Story 6: Add Debouncing to Project Form Input Handler\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:284-287\nhandleInputChange() {\n  const formData = this.getFormData()\n  this.intents.updateConfig(formData)  // Called on every input event\n}\n```\n\n**Technical Approach:**\n1. Create a debounce utility function (or use existing if available)\n2. Wrap `handleInputChange` with 500ms debounce\n3. Ensure debounced function is created once in constructor\n\n**Implementation:**\n```javascript\n// Add debounce helper (can be added at file level or in a utils module)\nfunction debounce(fn, delay) {\n  let timeoutId\n  return function(...args) {\n    clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n// In constructor:\nconstructor(intents) {\n  // ... existing code\n  this.debouncedHandleInputChange = debounce(() => {\n    const formData = this.getFormData()\n    this.intents.updateConfig(formData)\n  }, 500)\n}\n\n// Update handleInputChange:\nhandleInputChange() {\n  this.debouncedHandleInputChange()\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 7: Add Null Checks to Project Form getFormData\n\n**Complexity:** Low\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:245-279\ngetFormData() {\n  return {\n    name: document.getElementById('project-name-input').value.trim(),  // Crashes if null!\n    // ... many more direct accesses\n  }\n}\n```\n\n**Technical Approach:**\n1. Create a helper method `getElementValue(id, defaultValue = '')` that safely gets value\n2. Replace all direct `getElementById(...).value` calls with the helper\n3. Handle checkboxes separately with `?.checked || false`\n\n**Implementation:**\n```javascript\n// Helper method\ngetElementValue(id, defaultValue = '') {\n  const element = document.getElementById(id)\n  if (!element) {\n    console.warn(`[ProjectForm] Missing form element: ${id}`)\n    return defaultValue\n  }\n  return element.value?.trim() ?? defaultValue\n}\n\ngetCheckboxValue(id, defaultValue = false) {\n  const element = document.getElementById(id)\n  return element?.checked ?? defaultValue\n}\n\n// Updated getFormData:\ngetFormData() {\n  return {\n    name: this.getElementValue('project-name-input'),\n    description: this.getElementValue('project-description'),\n    assumptions: this.assumptions.filter(a => a.trim()),\n    technicalArchitecture: this.getElementValue('technical-architecture'),\n    dataModel: this.getElementValue('data-model'),\n    defaultModel: this.getElementValue('default-model', 'optus'),\n    options: {\n      programmingStyle: this.getElementValue('programming-style', 'hybrid'),\n      testingApproach: this.getElementValue('testing-approach', 'bdd'),\n      // ... etc\n    },\n    debugMode: this.getCheckboxValue('debug-mode-checkbox')\n  }\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n### Story 8: Validate Plugin Icons Before DOM Insertion\n\n**Complexity:** Medium\n\n**Current State:**\n```javascript\n// src/renderer/components/project-form/project-form.js:479-484\nconst icon = plugin.icon || 'ðŸ”§'\nitem.innerHTML = `\n  <div class=\"plugin-item-icon\">${icon}</div>  // Direct insertion - XSS risk!\n  ...\n`\n```\n\n**Technical Approach:**\nPer clarification: support text-based icons (like \"JS\" or \"TS\") in addition to emoji.\n\n1. Create `validatePluginIcon(icon)` function that:\n   - Returns the icon if it's a valid emoji (single emoji or emoji sequence)\n   - Returns the icon if it's short text (1-4 alphanumeric characters)\n   - Returns fallback 'ðŸ”§' for invalid/malicious content\n2. Use `textContent` instead of `innerHTML` for the icon element to prevent XSS\n\n**Implementation:**\n```javascript\n/**\n * Validate plugin icon for safe DOM insertion.\n * Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n * Rejects: HTML, scripts, long strings\n */\nvalidatePluginIcon(icon) {\n  const DEFAULT_ICON = 'ðŸ”§'\n  \n  if (!icon || typeof icon !== 'string') {\n    return DEFAULT_ICON\n  }\n  \n  // Trim and limit length (max 8 chars to allow emoji sequences or short text)\n  const trimmed = icon.trim()\n  if (trimmed.length === 0 || trimmed.length > 8) {\n    return DEFAULT_ICON\n  }\n  \n  // Check for dangerous characters (HTML/script injection)\n  if (/<|>|&|javascript:|data:|on\\w+=/i.test(trimmed)) {\n    console.warn(`[ProjectForm] SECURITY: Rejected unsafe plugin icon: ${icon}`)\n    return DEFAULT_ICON\n  }\n  \n  // Allow emoji pattern (Unicode emoji ranges) or alphanumeric text (1-4 chars)\n  const isEmoji = /^[\\p{Emoji}\\p{Emoji_Modifier}\\p{Emoji_Component}\\p{Emoji_Modifier_Base}\\p{Emoji_Presentation}]+$/u.test(trimmed)\n  const isShortText = /^[A-Za-z0-9]{1,4}$/.test(trimmed)\n  \n  if (isEmoji || isShortText) {\n    return trimmed\n  }\n  \n  return DEFAULT_ICON\n}\n\n// Update rendering to use textContent:\nrenderPluginList() {\n  this.plugins.forEach(plugin => {\n    const item = document.createElement('div')\n    item.className = `plugin-item ${plugin.enabled === false ? 'disabled' : ''}`\n    item.dataset.pluginId = plugin.id\n\n    const icon = this.validatePluginIcon(plugin.icon)\n    \n    // Build structure with safe DOM methods\n    const iconDiv = document.createElement('div')\n    iconDiv.className = 'plugin-item-icon'\n    iconDiv.textContent = icon  // Safe - no HTML parsing\n    \n    // ... rest of item construction\n  })\n}\n```\n\n**Files Changed:**\n- `src/renderer/components/project-form/project-form.js`\n\n---\n\n## Risk Assessment\n\n| Story | Risk Level | Potential Challenges |\n|-------|------------|---------------------|\n| 1 | Low | Edge cases with Windows path separators |\n| 2 | Low | Determining appropriate size limit (50MB per requirement) |\n| 3 | Low | None significant |\n| 4 | Low | UX decision on what happens when limit reached during multi-paste |\n| 5 | Medium | Ensuring modal re-renders correctly without flicker |\n| 6 | Low | Ensuring debounce doesn't prevent final save |\n| 7 | Low | Identifying all form elements that need null checks |\n| 8 | Medium | Defining \"valid\" icon patterns (emoji detection regex complexity) |\n\n---\n\n## Estimated Complexity\n\n| Story | Complexity | Rationale |\n|-------|------------|-----------|\n| 1 | **Low** | Single method change with clear validation logic |\n| 2 | **Low** | Single validation check in IPC handler |\n| 3 | **Low** | Remove break statement, minor loop restructure |\n| 4 | **Low** | Add constant and single check before processing |\n| 5 | **Medium** | Requires understanding async flow and modal re-render |\n| 6 | **Low** | Standard debounce pattern |\n| 7 | **Low** | Repetitive but straightforward null checks |\n| 8 | **Medium** | Regex patterns for emoji/text validation |\n\n---\n\n## Testing Strategy\n\n### Story 1 (Path Traversal)\n- Test with valid temp directory path â†’ success\n- Test with `../../../etc/passwd` style paths â†’ rejected\n- Test with absolute paths outside temp â†’ rejected\n- Test with null/undefined paths â†’ rejected\n\n### Story 2 (File Size)\n- Test with image under 50MB â†’ success\n- Test with image exactly 50MB â†’ success\n- Test with image 50.1MB â†’ error with clear message\n- Verify error message shows actual size\n\n### Story 3 (Multi-Image Paste)\n- Paste clipboard with 1 image â†’ 1 attached\n- Paste clipboard with 3 images â†’ 3 attached\n- Paste mixed content (text + images) â†’ images attached, text handled normally\n\n### Story 4 (Max Attachments)\n- Add 5 images â†’ all attached\n- Try to add 6th image â†’ warning toast, image not added\n- Verify count after removing and re-adding\n\n### Story 5 (Race Condition)\n- Open sprint close modal â†’ loading state shows OR message displays\n- Verify no duplicate generation calls\n- Verify message appears after generation completes\n\n### Story 6 (Debouncing)\n- Rapid typing â†’ only final state saved\n- 500ms pause â†’ save triggered\n- Verify form remains responsive\n\n### Story 7 (Null Checks)\n- Normal form â†’ all values collected\n- Missing element â†’ default used, warning logged\n- Verify no crashes with missing elements\n\n### Story 8 (Icon Validation)\n- Valid emoji `ðŸ”§` â†’ displayed\n- Short text `JS` â†’ displayed\n- HTML `<script>` â†’ rejected, default shown\n- Long string â†’ rejected, default shown\n\n---\n\n## Open Questions\n\nAll clarifications have been addressed:\n\n| Question | Resolution |\n|----------|------------|\n| Story 4: How to show limit warning? | âœ… \nWarning toast |\n| Story 5: Race condition source? | âœ… \nInvestigate SAM actions and UI components calling showSprintCloseModal |\n| Story 6: Debounce delay? | âœ… 500ms |\n| Story 8: What icons to support? | âœ… \nEmoji + text-based icons (like \"JS\", \"TS\") |\n\n---\n\n## Summary\n\nThis sprint consists of 8 focused stories that improve security (3 stories), fix bugs (2 stories), and enhance robustness (3 stories). The recommended implementation order prioritizes security fixes first, followed by functionality bugs, then enhancements. Total estimated effort is straightforward with no blocking dependencies between stories, allowing parallel development if needed.\n\n---\n\n\n### Implementation Notes\nThis is part of an approved sprint plan. Please implement this story following the established patterns in the codebase and the guidance above.\n\n---\n\nPlease proceed with the implementation.",
          "title": "[Sprint] Validate Plugin Icons Before DOM Insertion - UI",
          "timestamp": 1767552953037,
          "response": {
            "content": "Implementation complete. Here's a summary:\n\n## Summary: Validate Plugin Icons Before DOM Insertion\n\n### Changes Made\n\n**File:** `src/renderer/components/project-form/project-form.js`\n\n1. **Added `validatePluginIcon()` method** (lines 467-502):\n   - Validates icons before DOM insertion to prevent XSS\n   - Accepts: emoji characters, short text labels (1-4 chars like \"JS\", \"TS\")\n   - Rejects: HTML tags, script injection, long strings\n   - Returns safe fallback `ðŸ”§` for invalid/malicious content\n   - Logs security warning when rejecting malicious icons\n\n2. **Updated plugin list rendering** (lines 560-612):\n   - Icon now uses `textContent` instead of `innerHTML` for maximum safety\n   - Calls `validatePluginIcon()` to sanitize icon before display\n   - Restructured DOM building to separate icon from innerHTML content\n\n3. **Updated plugin preview rendering** (lines 951-959):\n   - Added `validatePluginIcon()` call for preview icons\n   - Wrapped validated icon with `escapeHtml()` for extra safety\n\n### Security Features\n\n| Protection | Implementation |\n|------------|----------------|\n| HTML injection | Regex check for `<`, `>`, `&` |\n| JavaScript URIs | Regex check for `javascript:`, `data:` |\n| Event handlers | Regex check for `on\\w+=` patterns |\n| Length limit | Max 8 characters |\n| DOM safety | Icon uses `textContent` (no parsing) |\n\n### Acceptance Criteria Verification\n\n| Criteria | Status |\n|----------|--------|\n| 1. Plugin icons are validated for safe content before DOM insertion | âœ… `validatePluginIcon()` checks all icons |\n| 2. Invalid or potentially malicious icons are rejected | âœ… \nXSS patterns detected and blocked |\n| 3. Safe fallback icon is used when validation fails | âœ… \nReturns `ðŸ”§` default icon |\n\n### Examples\n\n| Input | Result |\n|-------|--------|\n| `ðŸ”§` | âœ… \nAccepted (emoji) |\n| `JS` | âœ… \nAccepted (short text) |\n| `<script>` | âŒ \nRejected (HTML) |\n| `<img onerror=alert(1)>` | âŒ \nRejected (XSS) |\n| `VeryLongIconText` | âŒ \nRejected (too long) |",
            "sessionId": "08257222-4ead-462f-8c7f-ccfe5f3cea98",
            "cost": 1.58997275,
            "turns": 18,
            "duration": 207562,
            "filesModified": [
              {
                "path": "C:\\Users\\jjdub\\code\\puffin\\src\\renderer\\components\\project-form\\project-form.js",
                "action": "write",
                "timestamp": 1767553127076
              }
            ],
            "timestamp": 1767553168874
          },
          "children": [],
          "sprintId": "mjzyrckck0yj9qpfq",
          "storyId": "c1deb716-bd5f-40c0-8314-2cf0aa2e3e8e",
          "branchType": "ui"
        },
        {
          "id": "mk27mhisvq3w3ka20",
          "parentId": null,
          "content": "## Implementation Request\n\n### RICE FACT Framework\n\n**Role:** You are a Senior UI/Frontend Developer specializing in user experience, accessibility, and modern frontend patterns.\n\n**Instruction:** Implement the user interface components for this user story. Create clean, reusable components with proper styling and user interactions.\n\n**Context:** This is the UI implementation thread. The backend may be implemented separately, so focus on the presentation layer and use mocks or stubs for data if needed.\n\n**Example:** Follow existing component patterns in the codebase. Reference similar UI elements for consistency in styling and behavior.\n\n**Format:** Provide complete component code with HTML structure, CSS/styling, and JavaScript interactions. Include accessibility attributes (ARIA labels, keyboard navigation).\n\n**Aim:** Create an intuitive, responsive, and visually consistent user interface that provides excellent user experience.\n\n**Constraints:** Follow existing design patterns and component architecture. Ensure accessibility (WCAG 2.1). Do not modify backend logic or data models.\n\n**Tone:** User-focused and detail-oriented. Prioritize clarity, usability, and visual polish.\n\n---\n\n### User Story\n**Week and Month View Toggle**\n\nAs a developer, I want to switch between weekly and monthly calendar views so that I can see my work at different time scales\n\n### Acceptance Criteria\n1. Toggle control allows switching between week and month view\n2. Week view displays 7 days in a row format\n3. Month view displays full month grid with day cells\n4. Current view preference persists during the session\n5. Navigation controls allow moving to previous/next week or month\n\n### Approved Implementation Plan\n\nThe following plan was approved for this sprint. Please follow this guidance:\n\n# Calendar Plugin Implementation Plan - Revised\n\n## Executive Summary\n\nThis plan outlines the implementation of a Calendar Plugin for Puffin that provides developers with a visual timeline of their development activity. The plugin will display sprints, git branches, and personal notes organized by date, with week and month view options.\n\n---\n\n## Architecture Analysis\n\n### Plugin Integration Points\n\nThe Calendar Plugin will integrate with Puffin's existing systems:\n\n1. **Plugin Architecture** (`src/renderer/lib/plugin-manager.js`) - Registration, activation, lifecycle\n2. **Sprint Data** (`sprint-history.json`, `active-sprint.json`) - Sprint history display\n3. **Git Operations** (`git-operations.json`) - Branch history per day\n4. **Plugin Storage** - Notes persistence via plugin data directory\n\n### Shared Components & Dependencies\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    Calendar Plugin                          â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ CalendarGridâ”‚  â”‚ DayCell     â”‚  â”‚ NavigationControls  â”‚  â”‚\nâ”‚  â”‚ (Week/Month)â”‚  â”‚ (Reusable)  â”‚  â”‚ (Prev/Next/Toggle)  â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SprintPanel â”‚  â”‚ SprintModal â”‚  â”‚ PostItNote          â”‚  â”‚\nâ”‚  â”‚ (Left Side) â”‚  â”‚ (Stories)   â”‚  â”‚ (Create/Edit/View)  â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                    Data Services                            â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚ SprintData  â”‚  â”‚ GitBranch   â”‚  â”‚ NotesStorage        â”‚  â”‚\nâ”‚  â”‚ Service     â”‚  â”‚ Service     â”‚  â”‚ Service             â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Key Dependencies Between Stories\n\n```\nStory 1 (Base Structure) â”€â”€â”¬â”€â”€â–º Story 2 (Views Toggle)\n                          â”‚\n                          â”œâ”€â”€â–º Story 3 (Sprint Panel) â”€â”€â–º Story 4 (Sprint Modal)\n                          â”‚\n                          â”œâ”€â”€â–º Story 5 (Git Branches)\n                          â”‚\n                          â””â”€â”€â–º Story 6 (Post-it Notes)\n```\n\n---\n\n## Implementation Order\n\n### Recommended Sequence\n\n| Phase | Story | Rationale |\n|-------|-------|-----------|\n| 1 | Story 1: Calendar Plugin Base Structure | Foundation - all other stories depend on this |\n| 2 | Story 2: Week and Month View Toggle | Core navigation before adding data overlays |\n| 3 | Story 3: Sprint History Panel | Primary data integration, reuses left panel pattern |\n| 4 | Story 4: Sprint User Stories Modal | Extends Story 3 functionality |\n| 5 | Story 5: Git Branch History Display | Independent data layer, can parallel Story 6 |\n| 6 | Story 6: Post-it Notes | Independent feature, can parallel Story 5 |\n\n**Note:** Stories 5 and 6 are independent of each other and could be implemented in parallel by different developers.\n\n---\n\n## Technical Approach by Story\n\n### Story 1: Calendar Plugin Base Structure\n\n**Complexity: Medium**\n\n#### Technical Decisions\n\n1. **Plugin Location**: Project-level `plugins/calendar/` for inclusion in Puffin distribution\n2. **Plugin Manifest**: Standard `plugin.json` with metadata and entry point\n3. **Rendering**: Plugin renders into the main content area when activated\n4. **No Hour Granularity**: Days are the smallest unit; no time slots within days\n\n#### Key Implementation Details\n\n- Plugin follows existing plugin architecture patterns\n- Main entry point exports `init()`, `activate()`, `deactivate()` methods\n- Calendar grid uses CSS Grid for layout\n- Day cells are clickable elements that emit selection events\n\n#### File Structure\n\n```\nplugins/\nâ””â”€â”€ calendar/\n    â”œâ”€â”€ plugin.json           # Plugin manifest\n    â”œâ”€â”€ index.js              # Main entry point\n    â”œâ”€â”€ calendar.css          # Plugin styles\n    â”œâ”€â”€ components/\n    â”‚   â”œâ”€â”€ CalendarView.js   # Main calendar container\n    â”‚   â””â”€â”€ DayCell.js        # Individual day component\n    â””â”€â”€ services/\n        â””â”€â”€ date-utils.js     # Date calculation helpers\n```\n\n---\n\n### Story 2: Week and Month View Toggle\n\n**Complexity: Medium**\n\n#### Technical Decisions\n\n1. **Default View**: Week view\n2. **Week Start**: System locale preference, defaulting to Sunday\n3. **Session Persistence**: View preference stored in memory (not persisted to disk)\n4. **Navigation**: Previous/Next buttons work relative to current view (week or month)\n\n#### Key Implementation Details\n\n- Toggle control renders as segmented button or tabs\n- Week view: Single row of 7 `DayCell` components\n- Month view: 6-row grid (to accommodate months spanning 6 weeks)\n- Locale detection via `Intl.Locale` or system settings\n- Navigation updates the visible date range without page reload\n\n#### Week Start Logic\n\n```javascript\n// Pseudocode for week start detection\nfunction getWeekStartDay() {\n  const locale = navigator.language || 'en-US';\n  // Use Intl.Locale weekInfo if available (modern browsers)\n  // Fallback to Sunday (0) as default\n  return localeWeekStart || 0;\n}\n```\n\n#### File Changes\n\n```\nplugins/calendar/\nâ”œâ”€â”€ components/\nâ”‚   â”œâ”€â”€ ViewToggle.js         # Week/Month toggle control\nâ”‚   â”œâ”€â”€ WeekView.js           # 7-day row layout\nâ”‚   â”œâ”€â”€ MonthView.js          # Full month grid layout\nâ”‚   â””â”€â”€ NavigationControls.js # Prev/Next/Today buttons\nâ””â”€â”€ services/\n    â””â”€â”€ date-utils.js         # Add locale-aware week calculations\n```\n\n---\n\n### Story 3: Sprint History Panel on Day Selection\n\n**Complexity: Medium**\n\n#### Technical Decision