/**
 * Puffin Q&A Bot - Answers questions in GitHub Discussions using Claude
 *
 * Environment variables required:
 * - ANTHROPIC_API_KEY: Your Claude API key
 * - GITHUB_TOKEN: GitHub token with discussion write permissions
 * - DISCUSSION_ID: The GraphQL node ID of the discussion
 * - DISCUSSION_BODY: The question text from the discussion
 * - DISCUSSION_TITLE: The title of the discussion
 * - REPO_OWNER: Repository owner (e.g., 'jdubray')
 * - REPO_NAME: Repository name (e.g., 'puffin')
 * - EVENT_TYPE: 'discussion' or 'discussion_comment'
 * - COMMENT_ID: The GraphQL node ID of the comment (for comment events)
 * - COMMENT_BODY: The comment text (for comment events)
 * - COMMENT_AUTHOR: The comment author's login (for comment events)
 */

import Anthropic from '@anthropic-ai/sdk';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load Puffin context
const puffinContext = readFileSync(join(__dirname, 'puffin-context.md'), 'utf-8');

const BOT_SIGNATURE = `\n\n---\n*This response was generated by the Puffin Q&A Bot powered by Claude. For complex questions or issues, please open a GitHub Issue.*`;
const BOT_SIGNATURE_MARKER = 'Puffin Q&A Bot powered by Claude';

/**
 * Fetch all comments in a discussion to build conversation context
 */
async function fetchDiscussionComments(discussionId, githubToken) {
  const query = `
    query GetDiscussionComments($id: ID!) {
      node(id: $id) {
        ... on Discussion {
          title
          body
          comments(first: 100) {
            nodes {
              id
              body
              author {
                login
              }
              createdAt
            }
          }
        }
      }
    }
  `;

  const response = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${githubToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query,
      variables: { id: discussionId }
    })
  });

  const result = await response.json();
  if (result.errors) {
    throw new Error('Failed to fetch comments: ' + JSON.stringify(result.errors));
  }

  return result.data.node;
}

/**
 * Check if a comment is from the bot
 */
function isBotComment(comment) {
  return comment.body && comment.body.includes(BOT_SIGNATURE_MARKER);
}

/**
 * Build conversation history for Claude from discussion comments
 */
function buildConversationHistory(discussion, comments, currentCommentBody) {
  const messages = [];

  // Add original question
  messages.push({
    role: 'user',
    content: `**Original Question: ${discussion.title}**\n\n${discussion.body || ''}`
  });

  // Add all previous comments in order
  for (const comment of comments) {
    // Skip the current comment being replied to
    if (comment.body === currentCommentBody) {
      continue;
    }

    if (isBotComment(comment)) {
      // Bot response - strip the signature for cleaner context
      const cleanBody = comment.body.replace(/\n\n---\n\*This response was generated by.*\*$/, '');
      messages.push({
        role: 'assistant',
        content: cleanBody
      });
    } else {
      // User comment/follow-up
      messages.push({
        role: 'user',
        content: comment.body
      });
    }
  }

  // Add the current follow-up question
  messages.push({
    role: 'user',
    content: currentCommentBody
  });

  return messages;
}

async function answerQuestion() {
  const {
    ANTHROPIC_API_KEY,
    GITHUB_TOKEN,
    DISCUSSION_ID,
    DISCUSSION_BODY,
    DISCUSSION_TITLE,
    EVENT_TYPE,
    COMMENT_BODY,
    COMMENT_AUTHOR
  } = process.env;

  // Validate required environment variables
  if (!ANTHROPIC_API_KEY) {
    throw new Error('ANTHROPIC_API_KEY is required');
  }
  if (!GITHUB_TOKEN) {
    throw new Error('GITHUB_TOKEN is required');
  }
  if (!DISCUSSION_ID) {
    throw new Error('DISCUSSION_ID is required');
  }

  const isCommentEvent = EVENT_TYPE === 'discussion_comment';

  // Initialize Anthropic client
  const anthropic = new Anthropic({
    apiKey: ANTHROPIC_API_KEY
  });

  const systemPrompt = `You are a helpful assistant for the Puffin project. Answer questions about Puffin based on the context provided below. Be concise, accurate, and helpful.

If you don't know the answer or the question is outside the scope of Puffin, politely say so.

If the question is not about Puffin at all (spam, unrelated topics), respond briefly that this discussion is for Puffin-related questions only.

Format your response in GitHub-flavored markdown.

## Puffin Project Context

${puffinContext}`;

  let messages;

  if (isCommentEvent) {
    // Handle follow-up comment
    console.log(`Processing follow-up from ${COMMENT_AUTHOR}...`);

    // Fetch discussion with all comments for context
    const discussion = await fetchDiscussionComments(DISCUSSION_ID, GITHUB_TOKEN);
    const comments = discussion.comments?.nodes || [];

    // Check if there's at least one bot response in the thread
    const hasBotResponse = comments.some(isBotComment);

    if (!hasBotResponse) {
      console.log('No prior bot response found in this discussion. Skipping to avoid spam.');
      return;
    }

    // Build full conversation history
    messages = buildConversationHistory(discussion, comments, COMMENT_BODY);
    console.log(`Built conversation with ${messages.length} messages`);

  } else {
    // Handle new discussion
    const question = `${DISCUSSION_TITLE}\n\n${DISCUSSION_BODY || ''}`.trim();
    console.log('Processing new question:', question.substring(0, 100) + '...');

    messages = [{
      role: 'user',
      content: question
    }];
  }

  // Generate answer using Claude
  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2048,
    messages,
    system: systemPrompt
  });

  const answer = response.content[0].text;

  console.log('Generated answer:', answer.substring(0, 200) + '...');

  // Post reply to GitHub Discussion using GraphQL API
  const graphqlQuery = `
    mutation AddDiscussionComment($discussionId: ID!, $body: String!) {
      addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
        comment {
          id
          url
        }
      }
    }
  `;

  const graphqlResponse = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query: graphqlQuery,
      variables: {
        discussionId: DISCUSSION_ID,
        body: answer + BOT_SIGNATURE
      }
    })
  });

  const result = await graphqlResponse.json();

  if (result.errors) {
    console.error('GraphQL errors:', result.errors);
    throw new Error('Failed to post comment: ' + JSON.stringify(result.errors));
  }

  console.log('Successfully posted answer:', result.data?.addDiscussionComment?.comment?.url);
  return result;
}

// Run the bot
answerQuestion().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
