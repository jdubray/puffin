/**
 * Puffin Q&A Bot - Answers questions in GitHub Discussions using Claude
 *
 * Environment variables required:
 * - ANTHROPIC_API_KEY: Your Claude API key
 * - GITHUB_TOKEN: GitHub token with discussion write permissions
 * - DISCUSSION_ID: The GraphQL node ID of the discussion
 * - DISCUSSION_BODY: The question text from the discussion
 * - DISCUSSION_TITLE: The title of the discussion
 * - REPO_OWNER: Repository owner (e.g., 'jdubray')
 * - REPO_NAME: Repository name (e.g., 'puffin')
 */

import Anthropic from '@anthropic-ai/sdk';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load Puffin context
const puffinContext = readFileSync(join(__dirname, 'puffin-context.md'), 'utf-8');

async function answerQuestion() {
  const {
    ANTHROPIC_API_KEY,
    GITHUB_TOKEN,
    DISCUSSION_ID,
    DISCUSSION_BODY,
    DISCUSSION_TITLE,
    REPO_OWNER,
    REPO_NAME
  } = process.env;

  // Validate required environment variables
  if (!ANTHROPIC_API_KEY) {
    throw new Error('ANTHROPIC_API_KEY is required');
  }
  if (!GITHUB_TOKEN) {
    throw new Error('GITHUB_TOKEN is required');
  }
  if (!DISCUSSION_ID) {
    throw new Error('DISCUSSION_ID is required');
  }

  const question = `${DISCUSSION_TITLE}\n\n${DISCUSSION_BODY || ''}`.trim();

  console.log('Processing question:', question.substring(0, 100) + '...');

  // Initialize Anthropic client
  const anthropic = new Anthropic({
    apiKey: ANTHROPIC_API_KEY
  });

  // Generate answer using Claude
  const systemPrompt = `You are a helpful assistant for the Puffin project. Answer questions about Puffin based on the context provided below. Be concise, accurate, and helpful.

If you don't know the answer or the question is outside the scope of Puffin, politely say so.

If the question is not about Puffin at all (spam, unrelated topics), respond briefly that this discussion is for Puffin-related questions only.

Format your response in GitHub-flavored markdown.

## Puffin Project Context

${puffinContext}`;

  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2048,
    messages: [
      {
        role: 'user',
        content: question
      }
    ],
    system: systemPrompt
  });

  const answer = response.content[0].text;

  console.log('Generated answer:', answer.substring(0, 200) + '...');

  // Post reply to GitHub Discussion using GraphQL API
  const graphqlQuery = `
    mutation AddDiscussionComment($discussionId: ID!, $body: String!) {
      addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
        comment {
          id
          url
        }
      }
    }
  `;

  const botSignature = `\n\n---\n*This response was generated by the Puffin Q&A Bot powered by Claude. For complex questions or issues, please open a GitHub Issue.*`;

  const graphqlResponse = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query: graphqlQuery,
      variables: {
        discussionId: DISCUSSION_ID,
        body: answer + botSignature
      }
    })
  });

  const result = await graphqlResponse.json();

  if (result.errors) {
    console.error('GraphQL errors:', result.errors);
    throw new Error('Failed to post comment: ' + JSON.stringify(result.errors));
  }

  console.log('Successfully posted answer:', result.data?.addDiscussionComment?.comment?.url);
  return result;
}

// Run the bot
answerQuestion().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
